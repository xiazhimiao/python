import pandas as pd
import plotly.express as px

# ====================== æ•°æ®åŠ è½½ä¸æ¸…æ´— ======================
# ä»ç¬¬ 17 è¡Œå¼€å§‹è¯»å–æ•°æ®ï¼ˆæ ¹æ®å¾®ä¿¡è´¦å•æ ¼å¼è°ƒæ•´ï¼Œå‡è®¾å‰16è¡Œä¸ºè¯´æ˜ï¼‰
df = pd.read_csv(
    "è¿‘ä¸€æœˆè´¦å•.csv",
    skiprows=16,
    header=0
)

# è¿‡æ»¤æ— æ•ˆè¡Œï¼ˆäº¤æ˜“æ—¶é—´å’Œé‡‘é¢éç©ºï¼‰
df = df[df["äº¤æ˜“æ—¶é—´"].notna() & df["é‡‘é¢(å…ƒ)"].notna()]

# å¤„ç†é‡‘é¢æ ¼å¼ï¼šå»é™¤Â¥ç¬¦å·å¹¶è½¬æ¢ä¸ºæ•°å€¼
df["é‡‘é¢(å…ƒ)"] = df["é‡‘é¢(å…ƒ)"].str.replace("Â¥", "").astype(float)

# æå–æ—¥æœŸï¼ˆä»…æ—¥æœŸéƒ¨åˆ†ï¼Œå»é™¤æ—¶é—´ï¼‰
df["æ—¥æœŸ"] = pd.to_datetime(df["äº¤æ˜“æ—¶é—´"]).dt.date

# ====================== æ•°æ®åˆ†ç»„ä¸ç»Ÿè®¡ ======================
# æŒ‰æ—¥æœŸå’Œäº¤æ˜“ç±»å‹åˆ†ç»„ï¼Œè®¡ç®—é‡‘é¢æ€»å’Œ
daily_type_summary = df.groupby(["æ—¥æœŸ", "äº¤æ˜“ç±»å‹"])["é‡‘é¢(å…ƒ)"].sum().reset_index()

# ====================== ç»˜åˆ¶åˆ†ç±»å †ç§¯æŸ±çŠ¶å›¾ ======================
fig = px.bar(
    daily_type_summary,
    x="æ—¥æœŸ",
    y="é‡‘é¢(å…ƒ)",
    color="äº¤æ˜“ç±»å‹",  # æŒ‰äº¤æ˜“ç±»å‹åˆ†è‰²
    title="ğŸ“Š æ¯æ—¥ä¸åŒäº¤æ˜“ç±»å‹æ”¶æ”¯åˆ†å¸ƒ",
    labels={
        "æ—¥æœŸ": "æ—¥æœŸ",
        "é‡‘é¢(å…ƒ)": "é‡‘é¢ï¼ˆå…ƒï¼‰",
        "äº¤æ˜“ç±»å‹": "äº¤æ˜“ç±»å‹"
    },
    height=600,
    width=1000
)

# ä¼˜åŒ–å›¾è¡¨å¸ƒå±€
fig.update_layout(
    plot_bgcolor="white",  # èƒŒæ™¯è‰²
    xaxis=dict(
        tickangle=45,  # æ—¥æœŸæ ‡ç­¾å€¾æ–œ45åº¦é¿å…é‡å 
        showgrid=True,  # æ˜¾ç¤ºç½‘æ ¼çº¿
        gridcolor="lightgray"
    ),
    yaxis=dict(
        showgrid=True,
        gridcolor="lightgray"
    ),
    legend=dict(title="äº¤æ˜“ç±»å‹", orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1)  # å›¾ä¾‹ä½ç½®
)

# æ˜¾ç¤ºå›¾è¡¨
# fig.show()

# åˆ†ç±»å †ç§¯æŸ±çŠ¶å›¾
# fig.write_html("stacked_bar_chart.html")

# fig.write_image("åˆ†ç±»å †ç§¯æŸ±çŠ¶å›¾.png")  # ä¿å­˜ä¸ºPNGå›¾ç‰‡
# æ•°æ®é‡å¤§ï¼Œä¸æ˜“æ¸²æŸ“
